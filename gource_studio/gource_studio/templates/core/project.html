{% extends 'core/base.html' %}

{% block page_css %}
  <style type="text/css">
    #gource-settings-container .form-group,
    #gource-settings-container-view .form-group {
        min-width: 400px;
    }
    #gource-settings-container .form-group,
    #gource-settings-container-view .form-group,
    #project-captions-list .form-group,
    #build-captions-list .form-group {
        margin-bottom: 0;
    }
    #gource-settings-container .form-group .form-control,
    #gource-settings-container-view .form-group .form-control,
    #project-captions-list .form-group .form-control,
    #build-captions-list .form-group .form-control {
        display: inline-block;
    }
    #project-manage-container .form-group label {
        width: 175px;
        justify-content: flex-end;
        margin-right: 12px;
    }
    #build-audio-video-settings label b,
    #project-audio-video-settings label b {
        min-width: 110px;
        display: inline-block;
    }
    #build-audio-video-settings .form-group,
    #project-audio-video-settings .form-group {
        margin-bottom: 0;
    }
    #project-audio-video-settings .build-audio-video-actions {
        margin-top: 1rem;
    }
    .bootstrap-datetimepicker-widget {
        font-size: 0.8em;
    }
    .bootstrap-datetimepicker-widget table td.day {
        padding: .3em .5em;
    }
    .bootstrap-datetimepicker-widget table td,
    .bootstrap-datetimepicker-widget table th {
        padding: .5em 0;
    }
    .nav-link.active {
        font-weight: bold;
    }

    a.nav-link-alt {
        color: #FF0000;
    }
    a.nav-link-alt:hover {
        color: #FF6600;
    }
    a.nav-link-sub {
        font-size: 0.9em;
        padding-left: 26px;
    }

    .nav-link > .fa.fa-external-link {
        font-size: 0.75em;
    }
    .project-nav-topbar {
        flex-wrap: nowrap;
        overflow-x: auto;
        white-space: nowrap;
    }
    @media(max-width: 640px) {
        .project-nav-topbar {
            padding-left: 40px;
        }
    }
    .project-nav-topbar .nav-link {
        font-size: 0.8em;
    }
    .project-nav-topbar .nav-link.active {
        border-bottom: 1px solid #CCCCCC;
    }
    .project-nav-topbar li.nav-item:not(:first-child) {
        border-left: 1px solid #EEEEEE;
    }
  @media(max-width: 577px) {
    .project-nav-topbar .nav-link {
        padding: 0.5rem 0.5rem;
    }
  }
    .project-nav-sidebar {
        white-space: nowrap;
        margin-left: -24px;
    }

    @media(max-width: 992px) {
        .project-nav-sidebar {
            margin-left: -48px;
        }
    }
    .project-nav-sidebar .nav-item {
        width: 100px;
    }
    .project-nav-sidebar .nav-link.active::after {
        content: "â¯";
        margin-right: -14px;
        padding-left: 6px;
    }
    .project-nav-sidebar .nav-item.separator {
        margin-left: 10px;
        width: 80px;
        border-bottom: 1px solid #DDDDDD;
    }
    #project-video-container {
        text-align: center;
        background: #000000;
    }
    #project-video-container .project-video-empty {
        max-height: 80vh;
        height: 600px;
        color: #FFFFFF;
        vertical-align: middle;
        padding: 230px 0;
        line-height: 36px;
    }
    .project-video {
        max-height: 80vh;
        width: 100%;
    }
    #project-video-container .queue-project-build-btn {
        opacity: 0.6;
    }
    #project-video-container .queue-project-build-btn:hover {
        opacity: 1.0;
    }
    #project-details-container .tab-pane {
        padding-top: 12px;
    }
    #project-details-container #project-details-pane.tab-pane {
        padding-top: 0;
    }
    #project-details-container .project-changed-notice {
        position: absolute;
        right: 0;
        z-index: 1;
        background: #F5F5F5;
        border: 1px solid #999999;
        padding: 2px 8px;
        border-radius: 0 10px 10px 0;
        text-align: center;
    }
    #project-details-container .project-changed-notice > div {
        font-size: 12px;
        padding-bottom: 4px;
    }
    .project-url-link {
        font-weight: bold;
        color: #333333;
    }
    .project-url-link:hover {
        color: #333333;
        text-decoration: underline;
    }
    .project-url-nolink {
        font-weight: bold;
        color: #999999;
    }
    #project-details-pane .row b {
        display: inline-block;
        width: 120px;
        text-align: right;
    }
  @media(max-width: 577px) {
    #project-details-pane .row b,
    #project-details-pane .row span {
        width: auto;
        text-align: center;
        display: block;
    }
  }
  @media(min-width: 992px) {
    #project-details-pane .row b {
        margin-left: 100px;
    }
  }
    .project-image-preview {
        max-height: 128px;
        max-width: 128px;
    }
    .project-nav-topbar {
        border-bottom: 1px solid #CCCCCC;
        margin-bottom: 12px;
    }
    .gource-option-container {
        display: flex;
        width: 100%;
    }
    .gource-option-container .gource-option-label {
        width: 160px;
        font-size: 12px;
        line-height: 32px;
        text-align: right;
        padding-right: 8px;
    }
    .gource-option-container .gource-option-value {
        flex: 1;
    }
    .gource-option-container .gource-option-value input {
        width: 200px;
    }
    .gource-option-container .gource-option-value .gource-option-remove {
        padding-left: 12px;
        cursor: pointer;
    }
    .gource-option-info {
        padding-left: 12px;
    }

    #project-captions-container {
    }
    #build-captions-list,
    #project-captions-list {
        min-width: 400px;
        max-height: 600px;
        overflow-y: auto;
    }
    #build-captions-list input.gource-caption-datetimepicker,
    #project-captions-list input.gource-caption-datetimepicker {
        border-radius: .2rem 0 0 .2rem;
        background: #F9F9F9;
        width: 150px;
        font-size: 12px;
        line-height: 32px;
    }
    #build-captions-list input.gource-caption-text,
    #project-captions-list input.gource-caption-text {
        border-radius: 0 .2rem .2rem 0;
        width: 60%;
        min-width: 200px;
        max-width: 500px;
        font-size: 12px;
        line-height: 32px;
    }
  @media(max-width: 993px) {
    #build-captions-list input.gource-caption-text,
    #project-captions-list input.gource-caption-text {
        width: 50%;
    }
  }
  @media(max-width: 751px) {
    #build-captions-list input.gource-caption-text,
    #project-captions-list input.gource-caption-text {
        width: 40%;
    }
    .project-caption-actions,
    .project-manage-actions,
    .project-setting-actions {
        margin-top: -65px;
    }
  }
    #project-gource-options-container {
        display: flex;
        width: 100%;
        margin-top: 12px;
    }
    .project-links-container .input-group {
        padding-bottom: 12px;
    }
    .project-links-container .input-group .form-control[readonly] {
        background-color: #FFFFFF;
    }
    .project-links-container .input-group-prepend .input-group-text {
        font-size: 12px;
        width: 120px;
        justify-content: flex-end;
    }
    .popover {
        max-width: 300px;   /* default: 276px */
    }
    .playlist-select-options-list li {
        list-style-type: none;
        position: relative;
    }
    .playlist-select-options-list li input[type="checkbox"] {
        height: 20px;
        width: 20px;
        top: 9px;
        position: absolute;
    }
    .playlist-select-options-list li > label {
        font-size: 24px;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 200px;
        margin-left: 32px;
    }
  </style>
{% endblock %}

{% block content %}
  {% with latest_build=project.latest_build %}
  <div id="project-video-container">
  {% if build.status == 'completed' and build.content %}
    <video class="project-video" controls poster="{% url 'project-build-screenshot' project.id build.id %}" preload="metadata">
      <source src="{% url 'project-build-video' project.id build.id %}" type="video/mp4">
    </video>
  {% else %}
    <div class="project-video-empty">
    {% if build.errored_at %}
        <div class="text-danger">Build Error</div>
      {% if build.error_description %}
        <small class="text-danger">{{ build.error_description }}</small>
      {% endif %}
    {% elif build.aborted_at %}
        <div class="text-danger">Build was aborted.</div>
    {% elif build.running_at %}
        <div>Currently building...</div>
        <h3><i class="fa fa-spin fa-spinner"></i></h3>
    {% elif build.queued_at %}
        <div>Waiting to build...</div>
        <h3><i class="fa fa-spin fa-spinner"></i></h3>
    {% else %}
        <div>No video available.</div>
        <button class="btn btn-sm btn-primary queue-project-build-btn" type="button">Build Now</button>
    {% endif %}
    </div>
  {% endif %}
  </div>

  <!-- Nav topbar (mobile) -->
  <div class="d-md-none">
    <ul class="project-nav-topbar nav justify-content-center">
      <li class="nav-item">
        <a class="nav-link active" href="#project-details-pane" data-toggle="tab" role="tab">Build</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#build-settings-pane" data-toggle="tab" role="tab">Settings</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#build-captions-pane" data-toggle="tab" role="tab">Captions</a>
      </li>
    {% if user_can_edit %}
      <li class="nav-item">
        <a class="nav-link nav-link-alt" href="#project-manage-pane" data-toggle="tab" role="tab">Manage</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-link-alt" href="#project-settings-pane" data-toggle="tab" role="tab">Settings</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-link-alt" href="#project-captions-pane" data-toggle="tab" role="tab">Captions</a>
      </li>
    {% endif %}
      <li class="nav-item">
          <a class="nav-link" href="{% url 'project-avatars' project.id %}">Avatars <i class="fa fa-external-link"></i></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'project-builds' project.id %}">Builds <i class="fa fa-external-link"></i></a>
      </li>
    </ul>
  </div>
  <div id="project-details-container" class="container">
  {% if user_can_edit %}
    <div class="project-changed-notice"{% if not project.is_project_changed or project.has_build_waiting %} style="display:none"{% endif %}>
      <div>Project was changed</div>
      <button class="queue-project-build-btn btn btn-sm btn-danger" type="button">
        Build Now
      </button>
    </div>
  {% endif %}
    <div class="row">
      <div class="col-1">
        <!-- Nav sidebar (desktop) -->
        <ul class="project-nav-sidebar nav flex-column d-none d-md-block" id="project-nav-tabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" href="#project-details-pane" data-toggle="tab" role="tab">Build</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-sub" href="#build-settings-pane" data-toggle="tab" role="tab">Settings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-sub" href="#build-captions-pane" data-toggle="tab" role="tab">Captions</a>
          </li>
        {% if user_can_edit %}
          <li class="nav-item separator"></li>
          <li class="nav-item">
            <a class="nav-link nav-link-alt" href="#project-manage-pane" data-toggle="tab" role="tab">Project</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-alt nav-link-sub" href="#project-settings-pane" data-toggle="tab" role="tab">Settings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-alt nav-link-sub" href="#project-captions-pane" data-toggle="tab" role="tab">Captions</a>
          </li>
        {% endif %}
          <li class="nav-item separator"></li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'project-avatars' project.id %}">Avatars <i class="fa fa-external-link"></i></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'project-builds' project.id %}">Builds <i class="fa fa-external-link"></i></a>
          </li>
        </ul>
      </div>

      <div class="col-10">
        <div class="container">
          <div class="tab-content" id="project-tab-content">
            <!-- Project Details -->
            <div class="tab-pane show active" id="project-details-pane" role="tabpanel">
              <div class="row justify-content-center text-center">
                <div class="col-12">
                {% if project.project_url %}
                  <a href="{{ project.project_url }}" class="project-url-link" target="_blank">{{ project.project_url }}</a>
                {% else %}
                  <span class="project-url-nolink">{{ project.name }}</span>
                {% endif %}
                </div>
              </div>

              <hr />

              <div id="project-details-actions-container" class="float-right">
              {% if request.user and not request.user.is_anonymous %}
                <a id="add-to-playlist-btn" class="btn btn-default btn-sm" title="Add to Playlist"$>
                  <i class="fa fa-plus-square"></i>
                </a>
              {% endif %}
              {% if build.status == 'completed' and build.content %}
                <a class="btn btn-default btn-sm" href="{% url 'project-build-video' project.id build.id %}" download="video-{{ build.id }}.mp4" title="Download video ({{ build.content.size|filesizeformat }})"$>
                  <i class="fa fa-download"></i>
                </a>
              {% endif %}
              </div>

              <div class="row">
                <div class="col-12">
                  <b>Branch:</b>
                  <span title="{{ project.project_branch }}">{{ project.project_branch }}</span>
                </div>
              {% if build.project_log_commit_hash %}
                <div class="col-12">
                  <b>Last Commit:</b>
                  <span title="{{ build.project_log_commit_time|date:"M j, Y H:i:s T" }}">
                    [{{ build.project_log_commit_time|date:"M j, Y" }}]
                  {{ build.project_log_commit_preview }}
                {% if build.project_log %}
                    <a class="btn btn-link" href="{% url 'project-build-project-log' project.id build.id %}" download="project.log" title="Download project log">
                      <i class="fa fa-file-text-o"></i>
                    </a>
                {% elif project.project_log %}
                    <a class="btn btn-link" href="{% url 'project-project-log' project.id %}" download="project.log" title="Download project log">
                      <i class="fa fa-file-text-o"></i>
                    </a>
                {% endif %}
                  </span>
                </div>
              {% endif %}
              </div>

              <hr />

              <div class="row justify-content-center text-center">
                <div class="col-6">
                  <b>Created:</b> {{ project.created_at|date:"M j, Y H:i:s T" }}
                </div>
                <div class="col-6">
                {% if build %}
                  <b>Last Updated:</b> {{ build.created_at|date:"M j, Y H:i:s T" }}
                {% endif %}
                </div>
              </div>

              <hr />

              <div class="project-links-container row">
                <h5>
                  <i class="fa fa-link"></i> &nbsp;
                  Links:
                </h5>
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Project Link</span>
                    </div>
                    <input id="project-video-link" class="form-control" type="text" value="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% if project.project_slug %}{% url 'project-details' project.project_slug %}{% else %}{% url 'project-details' project.id %}{% endif %}" readonly />
                    <div class="input-group-append" title="Copy to clipboard">
                        <button class="btn btn-outline-secondary copy-clipboard-url" type="button"><i class="fa fa-clipboard"></i></span>
                    </div>
                </div>

                {% if build.status == 'completed' and build.content %}
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Direct Video Link</span>
                    </div>
                {% if project.project_slug %}
                    <input id="project-video-direct-link" class="form-control" type="text" value="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% if build.id == latest_build.id %}{% url 'project-latest-build-video' project.project_slug %}{% else %}{% url 'project-build-video' project.project_slug build.id %}{% endif %}" readonly />
                {% else %}
                    <input id="project-video-direct-link" class="form-control" type="text" value="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% if build.id == latest_build.id %}{% url 'project-latest-build-video' project.id %}{% else %}{% url 'project-build-video' project.id build.id %}{% endif %}" readonly />
                {% endif %}
                    <div class="input-group-append" title="Copy to clipboard">
                        <button class="btn btn-outline-secondary copy-clipboard-url" type="button"><i class="fa fa-clipboard"></i></span>
                    </div>
                </div>
                {% endif %}
              </div>
              {% if latest_build and build.id != latest_build.id %}
              <div class="row justify-content-center text-center">
                <div class="col-12">
                    <i><a href="{% url 'project-details' project.id %}">See Latest Build</a></i>
                </div>
              </div>
              {% endif %}
            </div>
            <!-- Build Settings -->
            <div class="tab-pane" id="build-settings-pane" role="tabpanel">
              <h5>
                <i class="fa fa-video-camera"></i> &nbsp;
                Audio / Video Settings
              </h5>
              <hr />
              <div id="build-audio-video-settings" class="row justify-content-center">
                <div class="col-12">
                  <div class="form-group form-inline">
                    <label><b>Video Size:</b>&nbsp;</label>
                    {% if build.video_size %}
                    <span>{{ build.video_size }}</span>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </div>

                  <div id="build-build-logo-form-group" class="form-group"{% if not build.build_logo %} style="display:none"{% endif %}>
                    <label><b>Logo Image:</b></label>
                    {% if build.build_logo %}
                    <button id="build-build-logo-preview" class="btn btn-sm btn-default popover-preview" data-src="{% url 'api-project-build-logo-download' project.id build.id %}">
                      <i class="fa fa-eye"></i>
                    </button>
                    {% endif %}
                  </div>

                  <div id="build-build-background-form-group" class="form-group"{% if not build.build_background %} style="display:none"{% endif %}>
                    <label><b>Background:</b></label>
                    {% if build.build_background %}
                    <button id="build-build-background-preview" class="btn btn-sm btn-default popover-preview" data-src="{% url 'api-project-build-background-download' project.id build.id %}">
                      <i class="fa fa-eye"></i>
                    </button>
                    {% endif %}
                  </div>

                  <div id="build-build-audio-form-group" class="form-group"{% if not build.build_audio_name %} style="display:none"{% endif %}>
                    <b>Background Music:</b>
                    {% if build.build_audio_name %}
                    <a href="{% url 'api-project-build-build-audio-download' project.id build.id %}" target="_blank">{{ build.build_audio_name }}</a>
                    {% endif %}
                  </div>
                </div>
              </div>
              <hr />
              <div>
                <h5 class="float-left" style="padding-right: 36px">
                  <i class="fa fa-sliders"></i> &nbsp;
                  Gource Settings
                </h5>
              </div>
              <div class="clearfix"></div>
              <div id="gource-settings-region-view">
                <div id="gource-settings-container-view">
                    <div class="text-muted" v-if="!options_selected.length">No settings found.</div>
                    <gource-option-view v-for="option in options_selected"
                                        v-on:remove-gource-option="removeOption(option.name)"
                                        v-on:change:value="updateValue(option, $event)"
                                        v-bind:key="option.name"
                                        v-bind="option"></gource-option-view>
                </div>
              </div>
            </div>

            <!-- Build Captions -->
            <div id="build-captions-pane" class="tab-pane" role="tabpanel">
              <div id="build-captions-region">
                <h5>
                  <i class="fa fa-tag"></i> &nbsp;
                  Video Captions
                </h5>
                <hr />
                <div class="row justify-content-center">
                  <div class="col-12">
                    <div id="build-captions-container">
                      <div id="build-captions-list">
                        <div class="text-muted" v-if="!captions_list.length">No captions set.</div>
                        <project-caption-view
                              v-for="caption in captions_list"
                              v-on:remove-caption="removeOption(caption.id)"
                              v-on:change-timestamp:timestamp="updateTimestamp(caption, $event)"
                              v-on:change-text:text="updateTimestamp(caption, $event)"
                              v-bind:key="caption.id"
                              v-bind="caption"></project-caption-view>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          {% if user_can_edit %}
            <!-- Project Settings -->
            <div class="tab-pane" id="project-settings-pane" role="tabpanel">
              <h5>
                <i class="fa fa-video-camera"></i> &nbsp;
                Audio / Video Settings
              </h5>
              <hr />

              <div class="project-setting-actions float-right">
                <button class="btn btn-success save-project-settings-btn"><i class="fa fa-disk"></i> Save</button>
              </div>

              <div id="project-audio-video-settings" class="row justify-content-center">
                <div class="col-12">
                  <div class="form-group form-inline">
                    <label for="project-video-size"><b>Video Size:</b>&nbsp;</label>
                    <select id="project-video-size" name="project-video-size" class="form-control form-control-sm">
                    {% for video_option in video_size_options %}
                      <option value="{{ video_option.0 }}"{% if project.video_size == video_option.0 %} selected="selected"{% endif %}>{{ video_option.1 }}</option>
                    {% endfor %}
                    </select>
                  </div>

                  <div id="project-build-logo-form-group" class="form-group"{% if not project.build_logo %} style="display:none"{% endif %}>
                    <label><b>Logo Image:</b></label>
                    {% if project.build_logo %}
                    <button id="project-build-logo-preview" class="btn btn-sm btn-default popover-preview" data-src="{% url 'api-project-logo-download' project.id %}">
                      <i class="fa fa-eye"></i>
                    </button>
                    {% endif %}
                    {% if project.build_logo %}
                    <a id="remove-project-logo-btn" class="btn btn-link text-danger" title="Delete logo"><i class="fa fa-times"></i></a>
                    {% endif %}
                    <form id="project_build_logo_file_form" method="POST" action="{% url 'project-build-logo-upload' project.id %}" class="form-inline" enctype="multipart/form-data"{% if project.build_logo %} style="display:none"{% endif %}>
                        <input id="project_build_logo_file" class="form-control form-control-file form-control-sm" type="file" name="build_logo" style="display:inline-block; width:auto;"/>
                        <button type="submit" class="btn btn-primary btn-sm">Upload</button>
                        {% csrf_token %}
                    </form>
                  </div>

                  <div id="project-build-background-form-group" class="form-group"{% if not project.build_background %} style="display:none"{% endif %}>
                    <label><b>Background:</b></label>
                    {% if project.build_background %}
                    <button id="project-build-background-preview" class="btn btn-sm btn-default popover-preview" data-src="{% url 'api-project-background-download' project.id %}">
                      <i class="fa fa-eye"></i>
                    </button>
                    {% endif %}
                    {% if project.build_background %}
                    <a id="remove-project-background-btn" class="btn btn-link text-danger" title="Delete background"><i class="fa fa-times"></i></a>
                    {% endif %}
                    <form id="project_build_background_file_form" method="POST" action="{% url 'project-build-background-upload' project.id %}" class="form-inline" enctype="multipart/form-data"{% if project.build_background %} style="display:none"{% endif %}>
                        <input id="project_build_background_file" class="form-control form-control-file form-control-sm" type="file" name="build_background" style="display:inline-block; width:auto;"/>
                        <button type="submit" class="btn btn-primary btn-sm">Upload</button>
                        {% csrf_token %}
                    </form>
                  </div>

                  <div id="project-build-audio-form-group" class="form-group"{% if not project.build_audio_name %} style="display:none"{% endif %}>
                    <b>Background Music:</b>
                    {% if project.build_audio %}
                    <a href="{% url 'api-project-build-audio-download' project.id %}" target="_blank">{{ project.build_audio_name }}</a>
                    <a class="btn btn-link edit-audio-file"><i class="fa fa-pencil"></i></a>
                    {% endif %}
                    <form id="project_build_audio_file_form" method="POST" action="{% url 'project-audio-upload' project.id %}" class="form-inline" enctype="multipart/form-data"{% if project.build_audio %} style="display:none"{% endif %}>
                        <input id="project_build_audio_file" class="form-control form-control-file form-control-sm" type="file" name="build_audio" style="display:inline-block; width:auto;"/>
                        <button type="submit" class="btn btn-primary btn-sm">Upload</button>
                      {% if project.build_audio %}
                        <a id="remove-project-build-audio-btn" class="btn btn-link text-danger" data-filename="{{ project.build_audio_name }}" title="Delete background music"><i class="fa fa-times"></i></a>
                      {% endif %}
                        {% csrf_token %}
                    </form>
                  </div>

                  <div class="build-audio-video-actions">
                    <button id="add-project-logo-btn" class="btn btn-sm btn-primary" role="button"{% if project.build_logo %} style="display:none"{% endif %}><i class="fa fa-rebel"></i> Add Logo</button>
                    <button id="add-project-background-btn" class="btn btn-sm btn-primary" role="button"{% if project.build_background %} style="display:none"{% endif %}><i class="fa fa-picture-o"></i> Add Background</button>
                    <button id="add-project-audio-btn" class="btn btn-sm btn-primary" role="button"{% if project.build_audio %} style="display:none"{% endif %}><i class="fa fa-music"></i> Add Music</button>
                  </div>
                </div>
              </div>
              <hr />
              <div>
                <h5 class="float-left" style="padding-right: 36px">
                  <i class="fa fa-sliders"></i> &nbsp;
                  Gource Settings
                </h5>
                <div id="gource-duration-estimate-container">
                    <small>Estimated Duration:</small>
                    <span id="gource-duration-estimate">-</span>
                  {% if not project.project_log %}
                    <span class="fa fa-exclamation-triangle text-danger" title="Project does not currently have a log associated with it" data-toggle="tooltip" data-placement="right"></i>
                  {% endif %}
                </div>
              </div>
              <div class="clearfix"></div>
              <div id="gource-settings-region">
                <div id="gource-settings-container">
                    <gource-option-edit v-for="option in options_selected"
                                        v-on:remove-gource-option="removeOption(option.name)"
                                        v-on:change:value="updateValue(option, $event)"
                                        v-bind:key="option.name"
                                        v-bind="option"></gource-option-edit>
                </div>
                <div id="project-gource-options-container" class="form-group gource-option-container">
                  <div class="input-group" style="width:305px">
                    <select id="gource-new-option-selector" class="form-control form-control-sm">
                      <option value="">-- Choose a Setting --</option>
                      <option is="gource-option-select"
                              v-for="option in options_available"
                              v-bind:key="option.name"
                              v-bind="option"></option>
                    </select>
                    <div class="input-group-append">
                      <button id="add-gource-option-btn" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> Add Setting</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          {% if user_can_edit %}
            <!-- Project Captions -->
            <div id="project-captions-pane" class="tab-pane" role="tabpanel">
              <div id="project-captions-region">
                <h5>
                  <i class="fa fa-tag"></i> &nbsp;
                  Video Captions
                </h5>

                <hr />

              {% if user_can_edit %}
                <div class="project-caption-actions float-right">
                {% if project.project_url_active %}
                  <div class="btn-group">
                    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false"><i class="fa fa-cog"></i></button>
                    <div class="dropdown-menu">
                      <a class="dropdown-item load-captions-from-project-tags-btn"><i class="fa fa-tag"></i> Load Repository Tags</a>
                    </div>
                  </div>
                {% endif %}
                  <button class="btn btn-success save-project-captions-btn"><i class="fa fa-disk"></i> Save</button>
                </div>
              {% endif %}

                <div class="row justify-content-center">
                  <div class="col-12">
                    <div id="project-captions-container">
                      <div id="project-captions-list">
                        <div class="text-muted text-center" v-if="!captions_list.length">No captions added yet.</div>
                        <project-caption-edit
                              v-for="caption in captions_list"
                              v-on:remove-caption="removeOption(caption.id)"
                              v-on:change-timestamp:timestamp="updateTimestamp(caption, $event)"
                              v-on:change-text:text="updateTimestamp(caption, $event)"
                              v-bind:key="caption.id"
                              v-bind="caption"></project-caption-edit>
                      </div>
                      <button class="btn btn-primary add-caption-btn" style="margin-top:1rem">
                        <i class="fa fa-plus"></i> Add Caption
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          {% if user_can_edit %}
            <!-- Project Manage -->
            <div id="project-manage-pane" class="tab-pane" role="tabpanel">
              <div id="project-manage-region">
                <h5>
                  <i class="fa fa-wrench"></i> &nbsp;
                  Manage Project
                </h5>

                <hr />

                <div class="project-manage-actions float-right">
                  <button class="btn btn-success save-project-manage-btn"><i class="fa fa-disk"></i> Save</button>
                </div>
                <div class="row justify-content-center">
                  <div class="col-12">
                    <div id="project-manage-container">
                      <div class="form-group form-inline">
                        <label for="project-name"><b>Project Name:</b>&nbsp;</label>
                        <input id="project-name" type="text" name="name" class="form-control form-control-sm" value="{{ project.name|default_if_none:"" }}" />
                      </div>
                      <div class="form-group form-inline">
                        <label for="project-slug"><b>Project Slug:</b>&nbsp;</label>
                        <input id="project-slug" type="text" name="project-slug" class="form-control form-control-sm" value="{{ project.project_slug|default_if_none:"" }}" />
                        <span class="gource-option-info" data-toggle="popover" data-trigger="hover" data-content="This is a unique identifier for the project and is used in URL links.">
                          <i class="fa fa-info-circle"></i>
                        </span>
                      </div>
                      <div class="form-group form-inline">
                        <label for="project-is-public"><b>Public Project:</b>&nbsp;</label>
                        <input id="project-is-public" type="checkbox" name="project-public" class="form-control" {% if project.is_public %}checked="checked"{% endif %}/>
                      </div>
                    {% if project.created_by %}
                      <div class="form-group form-inline">
                        <label><b>Created By:</b>&nbsp;</label>
                        <span>{{ project.created_by.username }}</span>
                      </div>
                    {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
        {% endif %}
          </div>
        </div>
      </div>

      <div class="col-1"></div>
    </div>
  </div>
  <!-- /.container -->

  {% endwith %}
  <hr />
  <br />


<!-- New Project Build -->
<div id="queue-project-build-modal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Project Build</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center">
        {% if project.project_url_active %}
          <input id="queue_project_build_refetch_log" type="checkbox" checked="checked" />
          <label for="queue_project_build_refetch_log">Download new project log</label>
        {% else %}
          <input id="queue_project_build_refetch_log" type="checkbox" disabled="disabled"/>
          <label for="queue_project_build_refetch_log" class="text-muted">Download new project log</label>
        {% endif %}
          <hr />
          <input id="queue_project_build_remix_audio" type="checkbox"/>
          <label for="queue_project_build_remix_audio">Remix background audio only</label>
          <small class="text-left" style="display:block;font-size:70%;">
            This option reuses the video from the last successful build
            and remixes the audio with the latest project audio.
            All the existing build settings will be copied over.
          </small>
        </div>
        <div class="error-message text-center text-danger"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Queue Build</button>
      </div>
    </div>
  </div>
</div>

<!--Delete XXX Modal -->
<div class="modal" id="confirm-delete-file-modal" tabindex="-1" role="dialog" aria-labelledby="confirm-delete-file-title" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirm-delete-file-title">Delete File?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <span id="confirm-delete-object-name">this file</span>?
        <h4 id="confirm-delete-file-name" class="text-center"></h4>
        <div id="confirm-delete-file-image" class="text-center"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger confirm-delete">Delete</button>
      </div>
    </div>
  </div>
</div>
<!-- Add to Playlist Modal -->
<div class="modal" id="confirm-add-to-playlist-modal" tabindex="-1" role="dialog" aria-labelledby="confirm-add-to-playlist-title" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirm-add-to-playlist-title">Add to Playlist</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="add-to-playlist-modal-options">
          <h3 class="text-center">
            <i class="fa fa-spin fa-spinner"></i>
          </h3>
        </div>
        <div class="add-new-playlist-region" style="display:none">
          <hr />
          <div class="add-to-playlist-modal-additional-options">
            <ul class="playlist-select-options-list"></ul>
          </div>
          <div class="input-group">
            <input class="form-control" type="text" placeholder="New Playlist" />
            <div class="input-group-append">
              <button class="create-playlist-btn btn btn-sm btn-success" role="button">
                <i class="fa fa-plus"></i>
                Create
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary confirm-save">Add Video</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
  <script src="/static/js/pages/project.js"></script>
  <script type="text/javascript">
    const PROJECT_ID = {{ project.id }};
    const CAN_USER_EDIT = {{ user_can_edit|lower }};
    const IS_LATEST_BUILD = {{ is_latest_build|lower }};
    const IS_READONLY = !CAN_USER_EDIT || !IS_LATEST_BUILD;
    $(document).ready(function() {
        "use strict";

        // Initialize page object
        App.pages.project.init(PROJECT_ID, {
            can_user_edit: CAN_USER_EDIT,
            is_latest_build: IS_LATEST_BUILD,
            is_readonly: IS_READONLY,
        });

        $('[data-toggle="tooltip"]').tooltip();
        $('#project-manage-pane [data-toggle="popover"]').popover();
        // Load all available build options for Gource
        let gource_options = [{% for gource_opt in gource_options_json %}
            {{ gource_opt|safe }},{% endfor %}
        ];
        // Apply 'index' property to each item to retain order for later sorts
        _.each(gource_options, function(item, idx) {
            item.index = idx;
        }, this);

        // Load current build options
        let init_project_options = [{% for option_json in project_options_json %}
            {{ option_json|safe }},{% endfor %}
        ];
        let init_build_options = [{% for option_json in build_options_json %}
            {{ option_json|safe }},{% endfor %}
        ];
        App.pages.project.project_settings_container.loadAvailable(gource_options);
        App.pages.project.build_settings_container.loadAvailable(App.utils.cloneJSON(gource_options));

        _.each(init_project_options, function(item) {
            App.debug && console.log("Initial setting: ", item);
            App.pages.project.project_settings_container.addOption(item.name, item.value, true);
        });
        _.each(init_build_options, function(item) {
            App.debug && console.log("Initial build setting: ", item);
            App.pages.project.build_settings_container.addOption(item.name, item.value, true);
        });

        App.pages.project.refreshGourceDuration();

        let init_project_captions = [{% for caption_json in project_captions_json %}
            {{ caption_json|safe }},{% endfor %}
        ];
        let init_build_captions = [{% for caption_json in build_captions_json %}
            {{ caption_json|safe }},{% endfor %}
        ];


        if (init_project_captions.length > 0) {
            _.each(init_project_captions, function(item) {
                let moment_timestamp = moment(item.timestamp);
                item.timestamp = moment_timestamp.format('YYYY-MM-DD HH:mm:ss');
                item.can_edit = !IS_READONLY;
                App.pages.project.project_captions_container.captions_list.push(item);
            });
        }
        if (init_build_captions.length > 0) {
            _.each(init_build_captions, function(item) {
                let moment_timestamp = moment(item.timestamp);
                item.timestamp = moment_timestamp.format('YYYY-MM-DD HH:mm:ss');
                App.pages.project.build_captions_container.captions_list.push(item);
            });
        }

        if (IS_READONLY) {
            // Remove selectable options
            // - Add Setting
            $('#project-gource-options-container').remove();
            // - Save Settings
            $('.save-project-settings-btn').remove();
            // - Edit Audio (Music) File
            $('.edit-audio-file').remove();
            // - Add/Save Captions
            $('.add-caption-btn').remove();
            $('.project-caption-actions').remove()
        }
    });
  </script>
{% endblock %}
