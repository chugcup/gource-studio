{% extends 'core/base.html' %}

{% block page_css %}
  <link rel="stylesheet" href="/static/css/lib/typeahead.css" />
  <style type="text/css">
  @media (min-width: 576px) and (max-width: 768px) {
    .container,
    .container-sm {
        max-width: none;
    }
  }
  @media (max-width: 575px) {
      dl dt {
          text-align: center;
      }
  }
  @media (min-width: 576px) {
      dl dt {
          text-align: right;
      }
  }
  @media (max-width: 992px) {
      dt.project-commit-hash-label,
      dd.project-commit-hash-value {
          font-size: 14px;
      }
  }
    #gource-settings-container .form-group,
    #gource-settings-container-view .form-group {
        min-width: 400px;
    }
    #gource-settings-container .form-group,
    #gource-settings-container-view .form-group,
    #project-captions-list .form-group,
    #build-captions-list .form-group {
        margin-bottom: 0;
    }
    #gource-settings-container .form-group .form-control,
    #gource-settings-container-view .form-group .form-control,
    #project-captions-list .form-group .form-control,
    #build-captions-list .form-group .form-control {
        display: inline-block;
    }
    #project-manage-container .form-group label {
        width: 175px;
        justify-content: flex-end;
        margin-right: 12px;
    }
    #project-manage-container .form-group input[type="text"] {
        width: 50%;
    }
    #build-audio-video-settings label b,
    #project-audio-video-settings label b {
        min-width: 110px;
        display: inline-block;
    }
    #build-audio-video-settings .form-group,
    #project-audio-video-settings .form-group {
        margin-bottom: 0;
    }
    #project-audio-video-settings .build-audio-video-actions {
        margin-top: 1rem;
    }
    #build-audio-video-settings .form-group > div,
    #project-audio-video-settings-region .form-group > div {
        display: inline-block;
        line-height: 2em;
    }
    #build-audio-video-settings .form-group label,
    #project-audio-video-settings-region .form-group label {
        width: 165px;
        text-align: right;
        margin-right: 12px;
        line-height: 2em;
        vertical-align: top;
    }
    #project-audio-video-settings-region .form-group select {
        display: inline-block;
        width: auto;
    }
    .bootstrap-datetimepicker-widget {
        font-size: 0.8em;
    }
    .bootstrap-datetimepicker-widget table td.day {
        padding: .3em .5em;
    }
    .bootstrap-datetimepicker-widget table td,
    .bootstrap-datetimepicker-widget table th {
        padding: .5em 0;
    }
    .nav-link.active {
        font-weight: bold;
    }

    a.nav-link-alt {
        color: #FF0000;
    }
    a.nav-link-alt:hover {
        color: #FF6600;
    }
    a.nav-link-sub {
        font-size: 0.9em;
        padding-left: 26px;
    }

    .nav-link > .fa.fa-external-link {
        font-size: 0.75em;
    }
    .project-nav-topbar {
        flex-wrap: nowrap;
        overflow-x: auto;
        white-space: nowrap;
    }
    @media(max-width: 640px) {
        .project-nav-topbar {
            padding-left: 40px;
        }
    }
    .project-nav-topbar .nav-link {
        font-size: 0.8em;
    }
    .project-nav-topbar .nav-link.active {
        border-bottom: 1px solid #CCCCCC;
    }
    .project-nav-topbar li.nav-item:not(:first-child) {
        border-left: 1px solid #EEEEEE;
    }
  @media(max-width: 577px) {
    .project-nav-topbar .nav-link {
        padding: 0.5rem 0.5rem;
    }
  }
    .project-nav-sidebar {
        white-space: nowrap;
        margin-left: -24px;
    }

    @media(max-width: 992px) {
        .project-nav-sidebar {
            margin-left: -48px;
        }
    }
    .project-nav-sidebar .nav-item {
        width: 100px;
    }
    .project-nav-sidebar .nav-link.active::after {
        content: "â¯";
        margin-right: -14px;
        padding-left: 6px;
    }
    .project-nav-sidebar .nav-item.separator {
        margin-left: 10px;
        width: 80px;
        border-bottom: 1px solid #DDDDDD;
    }
    #project-video-container {
        text-align: center;
        background: #000000;
    }
    #project-video-container .project-video-empty {
        max-height: 80vh;
        height: 600px;
        color: #FFFFFF;
        vertical-align: middle;
        padding: 230px 0;
        line-height: 36px;
    }
    .project-video {
        max-height: 80vh;
        width: 100%;
    }
    #project-video-container .queue-project-build-btn {
        opacity: 0.6;
    }
    #project-video-container .queue-project-build-btn:hover {
        opacity: 1.0;
    }
    #project-details-container .tab-pane {
        padding-top: 12px;
    }
    #project-details-container #project-details-pane.tab-pane {
        padding-top: 0;
    }
    #project-details-container .project-changed-notice {
        position: absolute;
        right: 0;
        z-index: 1;
        background: #F5F5F5;
        border: 1px solid #999999;
        padding: 2px 8px;
        border-radius: 0 10px 10px 0;
        text-align: center;
    }
    #project-details-container .project-changed-notice > div {
        font-size: 12px;
        padding-bottom: 4px;
    }
    .project-url-link {
        font-weight: bold;
        color: #333333;
    }
    .project-url-link:hover {
        color: #333333;
        text-decoration: underline;
    }
    .project-url-nolink {
        font-weight: bold;
        color: #999999;
    }
    #project-details-pane .row b {
        display: inline-block;
        width: 120px;
        text-align: right;
    }
  @media(max-width: 577px) {
    #project-details-pane .row b,
    #project-details-pane .row span {
        width: auto;
        text-align: center;
        display: block;
    }
  }
  @media(min-width: 992px) {
    #project-details-pane .row b {
        margin-left: 100px;
    }
  }
    .project-image-preview {
        max-height: 128px;
        max-width: 128px;
    }
    .project-image-preview-dimensions {
        text-align: center;
        color: #999999;
    }
    .project-nav-topbar {
        border-bottom: 1px solid #CCCCCC;
        margin-bottom: 12px;
    }
    .gource-option-container {
        display: flex;
        width: 100%;
    }
    .gource-option-container .gource-option-label {
        width: 160px;
        font-size: 12px;
        line-height: 32px;
        text-align: right;
        padding-right: 8px;
    }
    .gource-option-container .gource-option-value {
        flex: 1;
    }
    .gource-option-container .gource-option-value .gource-option-value-input,
    .gource-option-container .gource-option-value .gource-option-value-bool {
        display: inline-block;
    }
    .gource-option-container .gource-option-value input {
        width: 200px;
    }
@media(max-width: 767px) {
    .gource-option-container .gource-option-value input {
        width: 180px;
    }
}
    .gource-option-container .gource-option-value .gource-option-remove {
        padding-left: 12px;
        cursor: pointer;
    }
    .gource-option-info {
        padding-left: 12px;
    }

    #project-captions-container {
    }
    #build-captions-list,
    #project-captions-list {
        min-width: 400px;
        max-height: 600px;
        overflow-y: auto;
    }
    #build-captions-list input.gource-caption-datetimepicker,
    #project-captions-list input.gource-caption-datetimepicker {
        border-radius: .2rem 0 0 .2rem;
        background: #F9F9F9;
        width: 150px;
        font-size: 12px;
        line-height: 32px;
    }
    #build-captions-list input.gource-caption-text,
    #project-captions-list input.gource-caption-text {
        border-radius: 0 .2rem .2rem 0;
        width: 60%;
        min-width: 200px;
        max-width: 500px;
        font-size: 12px;
        line-height: 32px;
    }
  @media(max-width: 993px) {
    #build-captions-list input.gource-caption-text,
    #project-captions-list input.gource-caption-text {
        width: 50%;
    }
  }
  @media(max-width: 751px) {
    #build-captions-list input.gource-caption-text,
    #project-captions-list input.gource-caption-text {
        width: 40%;
    }
    .project-caption-actions,
    .project-manage-actions,
    .project-setting-actions {
        margin-top: -65px;
    }
  }
    #project-gource-options-container {
        display: flex;
        width: 100%;
        margin-top: 12px;
    }
    .project-links-container .input-group {
        padding-bottom: 12px;
    }
    .project-links-container .input-group .form-control[readonly] {
        background-color: #FFFFFF;
    }
    .project-links-container .input-group-prepend .input-group-text {
        font-size: 12px;
        width: 120px;
        justify-content: flex-end;
    }
    .popover {
        max-width: 300px;   /* default: 276px */
    }
    .playlist-select-options-list li {
        list-style-type: none;
        position: relative;
    }
    .playlist-select-options-list li input[type="checkbox"] {
        height: 20px;
        width: 20px;
        top: 9px;
        position: absolute;
    }
    .playlist-select-options-list li > label {
        font-size: 24px;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 200px;
        margin-left: 32px;
    }
    #display-gource-command-container {
        font-family: monospace;
        background: #000000;
        color: #DDDDDD;
        white-space: pre;
        padding: 4px 4px 4px 24px;
        font-size: 12px;
        min-height: 64px;
        overflow-x: auto;
        margin-top: 8px;
        border-radius: 4px;
    }
    #copy-gource-command-clipboard-btn {
        position: absolute;
        right: 16px;
        top: 48px;
        font-size: 12px;
        padding: 2px 6px;
        z-index: 10;
    }
    .project-member-icon {
        display: inline-block;
        width: 30px;
        text-align: center;
    }
    #new-member-input-container .tt-menu {
        top: 22px !important;
    }
    #new-member-input-container .tt-hint,
    #new-member-input-container #new-member-input {
        margin-top: -7px;
    }
    #new-member-input-container #new-member-input {
        margin-left: -1px;
    }
    #add-new-member-btn {
        margin-left: 34px;
    }
    .project-member-list-container {
        white-space: nowrap;
        margin-left: -40px;
    }
    .project-member-list-container input.form-control,
    .project-member-list-container select.form-control {
        width: 180px;
        display: inline-block;
    }
  @media (max-width: 576px) {
    #new-member-input-container input#new-member-input,
    #new-member-input-container input.form-control {
        width: 180px !important;
    }
  }
  @media (min-width: 576px) {
    .project-member-list-container {
        margin-left: 0px;
    }
    #new-member-input-container input#new-member-input,
    #new-member-input-container input.form-control[name="username"],
    .project-member-list-container input.form-control[name="username"] {
        width: 400px;
        display: inline-block;
    }
  }
  </style>
{% endblock %}

{% block content %}
  {% with latest_build=project.latest_build %}
  <div id="project-video-container">
  {% if build.status == 'completed' and build.content %}
    <video class="project-video" controls poster="{% url 'project-build-screenshot' project.id build.id %}" preload="metadata">
      <source src="{% url 'project-build-video' project.id build.id %}" type="video/mp4">
    </video>
  {% else %}
    <div class="project-video-empty">
    {% if build.errored_at %}
        <div class="text-danger">Build Error</div>
      {% if build.error_description %}
        <small class="text-danger">{{ build.error_description }}</small>
      {% endif %}
    {% elif build.aborted_at %}
        <div class="text-danger">Build was aborted.</div>
    {% elif build.running_at %}
        <div>Currently building...</div>
        <h3><i class="fa fa-spin fa-spinner"></i></h3>
    {% elif build.queued_at %}
        <div>Waiting to build...</div>
        <h3><i class="fa fa-spin fa-spinner"></i></h3>
    {% else %}
        <div>No video available.</div>
        <button class="btn btn-sm btn-primary queue-project-build-btn" type="button">Build Now</button>
    {% endif %}
    </div>
  {% endif %}
  </div>

  <!-- Nav topbar (mobile) -->
  <div class="d-md-none">
    <ul class="project-nav-topbar nav justify-content-center">
      <li class="nav-item">
        <a class="nav-link active" href="#project-details-pane" data-toggle="tab" role="tab">Build</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#build-settings-pane" data-toggle="tab" role="tab">Settings</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#build-captions-pane" data-toggle="tab" role="tab">Captions</a>
      </li>
    {% if user_can_edit %}
      <li class="nav-item">
        <a class="nav-link nav-link-alt" href="#project-manage-pane" data-toggle="tab" role="tab">Manage</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-link-alt" href="#project-settings-pane" data-toggle="tab" role="tab">Settings</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-link-alt" href="#project-captions-pane" data-toggle="tab" role="tab">Captions</a>
      </li>
      {% if project_user_role in maintainer_role %}
      <li class="nav-item">
        <a class="nav-link nav-link-alt" href="#project-members-pane" data-toggle="tab" role="tab">Members</a>
      </li>
      {% endif %}
    {% endif %}
      <li class="nav-item">
          <a class="nav-link" href="{% url 'project-avatars' project.id %}">Avatars <i class="fa fa-external-link"></i></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'project-builds' project.id %}">Builds <i class="fa fa-external-link"></i></a>
      </li>
    </ul>
  </div>
  <div id="project-details-container" class="container">
  {% if user_can_edit %}
    <div class="project-changed-notice"{% if not project.is_project_changed or project.has_build_waiting %} style="display:none"{% endif %}>
      <div>Project was changed</div>
      <button class="queue-project-build-btn btn btn-sm btn-danger" type="button">
        Build Now
      </button>
    </div>
  {% endif %}
    <div class="row">
      <div class="col-1">
        <!-- Nav sidebar (desktop) -->
        <ul class="project-nav-sidebar nav flex-column d-none d-md-block" id="project-nav-tabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" href="#project-details-pane" data-toggle="tab" role="tab">Build</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-sub" href="#build-settings-pane" data-toggle="tab" role="tab">Settings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-sub" href="#build-captions-pane" data-toggle="tab" role="tab">Captions</a>
          </li>
        {% if user_can_edit %}
          <li class="nav-item separator"></li>
          <li class="nav-item">
            <a class="nav-link nav-link-alt" href="#project-manage-pane" data-toggle="tab" role="tab">Project</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-alt nav-link-sub" href="#project-settings-pane" data-toggle="tab" role="tab">Settings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-alt nav-link-sub" href="#project-captions-pane" data-toggle="tab" role="tab">Captions</a>
          </li>
          {% if project_user_role in maintainer_role %}
          <li class="nav-item">
            <a class="nav-link nav-link-alt nav-link-sub" href="#project-members-pane" data-toggle="tab" role="tab">Members</a>
          </li>
          {% endif %}
        {% endif %}
          <li class="nav-item separator"></li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'project-avatars' project.id %}">Avatars <i class="fa fa-external-link"></i></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'project-builds' project.id %}">Builds <i class="fa fa-external-link"></i></a>
          </li>
        </ul>
      </div>

      <div class="col-10">
        <div class="container">
          <div id="project-tab-content" class="tab-content">
            <!-- Project Details -->
            <div id="project-details-pane" class="tab-pane show active" role="tabpanel">
              <div class="row justify-content-center text-center">
                <div class="col-12">
                {% if project.project_url %}
                  <a href="{{ project.project_url }}" class="project-url-link" target="_blank">{{ project.project_url }}</a>
                {% else %}
                  <span class="project-url-nolink">{{ project.name }}</span>
                {% endif %}
                </div>
              </div>

              <hr />

              <div id="project-details-actions-container" class="float-right">
              {% if build.project_log %}
                <a class="btn btn-link" href="{% url 'project-build-project-log' project.id build.id %}" download="project.log" title="Download project log">
                  <i class="fa fa-file-text-o"></i> Project Log
                </a>
              {% elif project.project_log %}
                <a class="btn btn-link" href="{% url 'project-project-log' project.id %}" download="project.log" title="Download project log">
                  <i class="fa fa-file-text-o"></i> Project Log
                </a>
              {% endif %}

              {% if request.user and not request.user.is_anonymous %}
                <a id="add-to-playlist-btn" class="btn btn-default btn-sm" title="Add to Playlist"$>
                  <i class="fa fa-plus-square"></i>
                </a>
              {% endif %}
              {% if build.status == 'completed' and build.content %}
                <a class="btn btn-default btn-sm" href="{% url 'project-build-video' project.id build.id %}" download="video-{{ build.id }}.mp4" title="Download video ({{ build.content.size|filesizeformat }})"$>
                  <i class="fa fa-download"></i>
                </a>
              {% endif %}
              </div>

              <div>
                <dl class="row">
                  <dt class="col-sm-4 col-md-4 col-lg-3 project-branch-label" title="Project branch">Branch:</dt>
                  <dd class="col-sm-8 col-md-8 col-lg-9 project-branch-value">
                    <span title="{{ project.project_branch }}">{{ project.project_branch }}</span>
                  </dd>
                {% if build.project_log_commit_hash %}
                  <dt class="col-sm-4 col-md-4 col-lg-3 project-commit-hash-label" title="Last project commit">
                    Last Commit:
                  </dt>
                  <dd class="col-sm-8 col-md-8 col-lg-9 project-commit-hash-value">
                    <span title="{{ build.project_log_commit_time|date:"M j, Y H:i:s T" }}">
                      [{{ build.project_log_commit_time|date:"M j, Y" }}]
                    {{ build.project_log_commit_preview }}
                    </span>
                  </dd>
                {% endif %}
                {% if build %}
                  <dt class="col-sm-4 col-md-4 col-lg-3">Last Updated:</dt>
                  <dd class="col-sm-8 col-md-8 col-lg-9">
                    <span>{{ build.created_at|date:"M j, Y H:i:s T" }}</span>
                  </dd>
                {% endif %}
                </dl>
              </div>

              <hr />

              <div class="project-links-container row">
                <h5>
                  <i class="fa fa-link"></i> &nbsp;
                  Links:
                </h5>
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Project Link</span>
                    </div>
                    <input id="project-video-link" class="form-control" type="text" value="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% if project.project_slug %}{% url 'project-details' project.project_slug %}{% else %}{% url 'project-details' project.id %}{% endif %}" readonly />
                    <div class="input-group-append" title="Copy to clipboard">
                        <button class="btn btn-outline-secondary copy-clipboard-url" type="button"><i class="fa fa-clipboard"></i></span>
                    </div>
                </div>

                {% if build.status == 'completed' and build.content %}
                <div class="input-group input-group-sm">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Direct Video Link</span>
                    </div>
                {% if project.project_slug %}
                    <input id="project-video-direct-link" class="form-control" type="text" value="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% if build.id == latest_build.id %}{% url 'project-latest-build-video' project.project_slug %}{% else %}{% url 'project-build-video' project.project_slug build.id %}{% endif %}" readonly />
                {% else %}
                    <input id="project-video-direct-link" class="form-control" type="text" value="{{ request.scheme }}://{{ request.META.HTTP_HOST }}{% if build.id == latest_build.id %}{% url 'project-latest-build-video' project.id %}{% else %}{% url 'project-build-video' project.id build.id %}{% endif %}" readonly />
                {% endif %}
                    <div class="input-group-append" title="Copy to clipboard">
                        <button class="btn btn-outline-secondary copy-clipboard-url" type="button"><i class="fa fa-clipboard"></i></span>
                    </div>
                </div>
                {% endif %}
              </div>
              {% if latest_build and build.id != latest_build.id %}
              <div class="row justify-content-center text-center">
                <div class="col-12">
                    <i><a href="{% url 'project-details' project.id %}">See Latest Build</a></i>
                </div>
              </div>
              {% endif %}
            </div>
            <!-- Build Settings -->
            <div id="build-settings-pane" class="tab-pane" role="tabpanel">
              <h5>
                <i class="fa fa-video-camera"></i> &nbsp;
                Audio / Video Settings
              </h5>
              <hr />
              <div id="build-audio-video-settings" class="row justify-content-center">
                <div class="col-12">
                  <div class="form-group">
                    <label><b>Video Size:</b>&nbsp;</label>
                    {% if build.video_size %}
                    <div id="build-video-size">{{ build.video_size }}</div>
                    {% else %}
                    <div class="text-muted">N/A</div>
                    {% endif %}
                  </div>

                  <div id="build-build-logo-form-group" class="form-group"{% if not build.build_logo %} style="display:none"{% endif %}>
                    <label><b>Logo Image:</b></label>
                    {% if build.build_logo %}
                    <div>
                      <button id="build-build-logo-preview" class="btn btn-sm btn-default popover-preview" data-src="{% url 'api-project-build-logo-download' project.id build.id %}">
                        <i class="fa fa-eye"></i>
                      </button>
                    </div>
                    {% endif %}
                  </div>

                  <div id="build-build-background-form-group" class="form-group"{% if not build.build_background %} style="display:none"{% endif %}>
                    <label><b>Background Image:</b></label>
                    {% if build.build_background %}
                    <div>
                      <button id="build-build-background-preview" class="btn btn-sm btn-default popover-preview" data-src="{% url 'api-project-build-background-download' project.id build.id %}">
                        <i class="fa fa-eye"></i>
                      </button>
                    </div>
                    {% endif %}
                  </div>

                  <div id="build-build-audio-form-group" class="form-group"{% if not build.build_audio_name %} style="display:none"{% endif %}>
                    <label><b>Background Music:</b></label>
                    {% if build.build_audio_name %}
                    <div>
                      <a href="{% url 'api-project-build-build-audio-download' project.id build.id %}" target="_blank">{{ build.build_audio_name }}</a>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              <hr />
              <div>
                <h5 class="float-left" style="padding-right: 36px">
                  <i class="fa fa-sliders"></i> &nbsp;
                  Gource Settings
                </h5>

                <div class="build-view-gource-command float-right">
                  <button id="build-view-gource-command-btn" class="btn btn-sm btn-default"><i class="fa fa-terminal"></i> View Command</button>
                </div>

              </div>
              <div class="clearfix"></div>
              <div id="gource-settings-region-view">
                <div id="gource-settings-container-view">
                    <div class="text-muted" v-if="!options_selected.length">No settings found.</div>
                    <gource-option-view v-for="option in options_selected"
                                        v-on:remove-gource-option="removeOption(option.name)"
                                        v-on:change:value="updateValue(option, $event)"
                                        v-bind:key="option.name"
                                        v-bind="option"></gource-option-view>
                </div>
              </div>
            </div>

            <!-- Build Captions -->
            <div id="build-captions-pane" class="tab-pane" role="tabpanel">
              <div id="build-captions-region">
                <h5>
                  <i class="fa fa-tag"></i> &nbsp;
                  Video Captions
                </h5>
                <hr />
                <div class="row justify-content-center">
                  <div class="col-12">
                    <div id="build-captions-container">
                      <div id="build-captions-list">
                        <div class="text-muted" v-if="!captions_list.length">No captions set.</div>
                        <project-caption-view
                              v-for="caption in captions_list"
                              v-on:remove-caption="removeOption(caption.id)"
                              v-on:change-timestamp:timestamp="updateTimestamp(caption, $event)"
                              v-on:change-text:text="updateTimestamp(caption, $event)"
                              v-bind:key="caption.id"
                              v-bind="caption"></project-caption-view>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          {% if user_can_edit %}
            <!-- Project Settings -->
            <div id="project-settings-pane" class="tab-pane" role="tabpanel">
              <h5>
                <i class="fa fa-video-camera"></i> &nbsp;
                Audio / Video Settings
              </h5>
              <hr />

              <div class="project-setting-actions float-right">
                <button class="btn btn-success save-project-settings-btn"><i class="fa fa-disk"></i> Save</button>
              </div>

              <div id="project-audio-video-settings" class="row justify-content-center">
                <div class="col-12">
                  <div id="project-audio-video-settings-region">
                    <project-audio-video-edit
                        v-bind:build_audio="build_audio"
                        v-bind:build_audio_name="build_audio_name"
                        v-bind:build_audio_upload="build_audio_upload"
                        v-bind:build_background="build_background"
                        v-bind:build_background_upload="build_background_upload"
                        v-bind:build_logo="build_logo"
                        v-bind:build_logo_upload="build_logo_upload"
                        v-bind:can_edit="can_edit"
                        v-bind:show_build_audio_form="show_build_audio_form"
                        v-bind:show_build_background_form="show_build_background_form"
                        v-bind:show_build_logo_form="show_build_logo_form"
                        v-bind:edit_build_audio="edit_build_audio"
                        v-bind:edit_build_background="edit_build_background"
                        v-bind:edit_build_logo="edit_build_logo"
                        v-bind:is_current_user="is_current_user"
                        v-bind:video_size="video_size"
                        v-bind:video_size_options="video_size_options"
                        v-on:toggle-show-project-logo-form="toggleShowProjectLogoForm"
                        v-on:toggle-show-project-background-form="toggleShowProjectBackgroundForm"
                        v-on:toggle-show-project-audio-form="toggleShowProjectAudioForm"
                        v-on:toggle-edit-project-logo="toggleEditProjectLogo"
                        v-on:toggle-edit-project-background="toggleEditProjectBackground"
                        v-on:toggle-edit-project-audio="toggleEditProjectAudio"></project-audio-video-edit>
                  </div>
                </div>
              </div>
              <hr />
              <div>
                <h5 class="float-left" style="padding-right: 36px">
                  <i class="fa fa-sliders"></i> &nbsp;
                  Gource Settings
                </h5>

                <div class="project-view-gource-command float-right">
                  <button id="project-view-gource-command-btn" class="btn btn-sm btn-default"><i class="fa fa-terminal"></i> View Command</button>
                </div>

                <div id="gource-duration-estimate-container">
                    <small>Estimated Duration:</small>
                    <span id="gource-duration-estimate">-</span>
                  {% if not project.project_log %}
                    <span class="fa fa-exclamation-triangle text-danger" title="Project does not currently have a log associated with it" data-toggle="tooltip" data-placement="right"></i>
                  {% endif %}
                </div>
              </div>
              <div class="clearfix"></div>
              <div id="gource-settings-region">
                <div id="gource-settings-container">
                    <gource-option-edit v-for="option in options_selected"
                                        v-on:remove-gource-option="removeOption(option.name)"
                                        v-on:change:value="updateValue(option, $event)"
                                        v-bind:key="option.name"
                                        v-bind="option"></gource-option-edit>
                </div>
                <div id="project-gource-options-container" class="form-group gource-option-container">
                  <div class="input-group" style="width:305px">
                    <select id="gource-new-option-selector" class="form-control form-control-sm">
                      <option value="">-- Choose a Setting --</option>
                      <option is="gource-option-select"
                              v-for="option in options_available"
                              v-bind:key="option.name"
                              v-bind="option"></option>
                    </select>
                    <div class="input-group-append">
                      <button id="add-gource-option-btn" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i> Add Setting</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          {% if user_can_edit %}
            <!-- Project Captions -->
            <div id="project-captions-pane" class="tab-pane" role="tabpanel">
              <div id="project-captions-region">
                <h5>
                  <i class="fa fa-tag"></i> &nbsp;
                  Video Captions
                </h5>

                <hr />

              {% if user_can_edit %}
                <div class="project-caption-actions float-right">
                {% if project.project_url_active %}
                  <div class="btn-group">
                    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false"><i class="fa fa-cog"></i></button>
                    <div class="dropdown-menu">
                      <a class="dropdown-item load-captions-from-project-tags-btn"><i class="fa fa-tag"></i> Load Repository Tags</a>
                    </div>
                  </div>
                {% endif %}
                  <button class="btn btn-success save-project-captions-btn"><i class="fa fa-disk"></i> Save</button>
                </div>
              {% endif %}

                <div class="row justify-content-center">
                  <div class="col-12">
                    <div id="project-captions-container">
                      <div id="project-captions-list">
                        <div class="text-muted text-center" v-if="!captions_list.length">No captions added yet.</div>
                        <project-caption-edit
                              v-for="caption in captions_list"
                              v-on:remove-caption="removeOption(caption.id)"
                              v-on:change-timestamp:timestamp="updateTimestamp(caption, $event)"
                              v-on:change-text:text="updateTimestamp(caption, $event)"
                              v-bind:key="caption.id"
                              v-bind="caption"></project-caption-edit>
                      </div>
                      <button class="btn btn-primary add-caption-btn" style="margin-top:1rem">
                        <i class="fa fa-plus"></i> Add Caption
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          {% if user_can_edit %}
            <!-- Project Manage -->
            <div id="project-manage-pane" class="tab-pane" role="tabpanel">
              <div id="project-manage-region">
                <h5>
                  <i class="fa fa-wrench"></i> &nbsp;
                  Manage Project
                </h5>

                <hr />

                <div class="project-manage-actions float-right">
                  <button class="btn btn-success save-project-manage-btn"><i class="fa fa-disk"></i> Save</button>
                </div>
                <div class="row justify-content-center">
                  <div class="col-12">
                    <div id="project-manage-container">
                    {% if project.created_by %}
                      <div class="form-group form-inline">
                        <label><b>Created By:</b>&nbsp;</label>
                        <span>{{ project.created_by.username }}</span>
                      </div>
                    {% endif %}
                      <div class="form-group form-inline">
                        <label for="project-name"><b>Project Name:</b>&nbsp;</label>
                        <input id="project-name" type="text" name="name" class="form-control form-control-sm" value="{{ project.name|default_if_none:"" }}" />
                      </div>
                      <div class="form-group form-inline">
                        <label for="project-slug"><b>Project Slug:</b>&nbsp;</label>
                        <input id="project-slug" type="text" name="project-slug" class="form-control form-control-sm" value="{{ project.project_slug|default_if_none:"" }}" />
                        <span class="gource-option-info" data-toggle="popover" data-trigger="hover" data-content="This is a unique identifier for the project and is used in URL links.">
                          <i class="fa fa-info-circle"></i>
                        </span>
                      </div>
                      <div class="form-group form-inline">
                        <label for="project-is-public"><b>Public Project:</b>&nbsp;</label>
                        <input id="project-is-public" type="checkbox" name="project-public" class="form-control" {% if project.is_public %}checked="checked"{% endif %}/>
                        <span class="gource-option-info" data-toggle="popover" data-trigger="hover" data-content="This will make project viewable to all users (not just project members)">
                          <i class="fa fa-info-circle"></i>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        {% endif %}
          {% if project_user_role in maintainer_role %}
            <!-- Project Members -->
            <div id="project-members-pane" class="tab-pane" role="tabpanel">
              <div id="project-members-region">
                <h5>
                  <i class="fa fa-group"></i> &nbsp;
                  Project Members
                </h5>
                <hr />

                <project-member-edit v-for="member in member_users_list"
                                     v-on:remove-project-member="removeMember(member.id)"
                                     v-on:change:role="changeRole(member, $event)"
                                     v-bind:key="member.id"
                                     v-bind="member"></project-member-edit>

                <div v-if="member_users_list.length === 0">
                  <i class="text-muted">No members yet.</i>
                </div>

                <hr />

                <div id="new-member-input-container">
                  <span id="new-member-icon" class="project-member-icon"></span>
                  <input id="new-member-input" type="text" class="form-control typeahead" name="username" autocomplete="off" placeholder="Username" style="width: 400px; display: inline-block"/>
                  <select id="new-member-role" name="role" class="form-control" style="width:180px; display: inline-block;">
                    <option value="viewer">Viewer</option>
                    <option value="developer">Developer</option>
                    <option value="maintainer">Maintainer</option>
                  </select>
                </div>
                <button id="add-new-member-btn" class="btn btn-primary" style="margin-top:1rem">
                  <i class="fa fa-plus"></i> Add Member
                </button>
              </div>
            </div>
          {% endif %}
          </div>
        </div>
      </div>

      <div class="col-1"></div>
    </div>
  </div>
  <!-- /.container -->

  {% endwith %}
  <hr />
  <br />


<!-- New Project Build -->
<div id="queue-project-build-modal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Project Build</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="text-center">
        {% if project.project_url_active %}
          <input id="queue_project_build_refetch_log" type="checkbox" checked="checked" />
          <label for="queue_project_build_refetch_log">Download new project log</label>
        {% else %}
          <input id="queue_project_build_refetch_log" type="checkbox" disabled="disabled"/>
          <label for="queue_project_build_refetch_log" class="text-muted">Download new project log</label>
        {% endif %}
          <hr />
          <input id="queue_project_build_remix_audio" type="checkbox"/>
          <label for="queue_project_build_remix_audio">Remix background audio only</label>
          <small class="text-left" style="display:block;font-size:70%;">
            This option reuses the video from the last successful build
            and remixes the audio with the latest project audio.
            All the existing build settings will be copied over.
          </small>
        </div>
        <div class="error-message text-center text-danger"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Queue Build</button>
      </div>
    </div>
  </div>
</div>

<!--Delete XXX Modal -->
<div class="modal" id="confirm-delete-file-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title confirm-delete-file-title">Delete File?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <span id="confirm-delete-object-name">this file</span>?
        <h4 class="confirm-delete-file-name text-center"></h4>
        <div class="confirm-delete-file-image text-center"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger confirm-delete">Delete</button>
      </div>
    </div>
  </div>
</div>
<!-- Add to Playlist Modal -->
<div class="modal" id="confirm-add-to-playlist-modal" tabindex="-1" role="dialog" aria-labelledby="confirm-add-to-playlist-title" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirm-add-to-playlist-title">Add to Playlist</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="add-to-playlist-modal-options">
          <h3 class="text-center">
            <i class="fa fa-spin fa-spinner"></i>
          </h3>
        </div>
        <div class="add-new-playlist-region" style="display:none">
          <hr />
          <div class="add-to-playlist-modal-additional-options">
            <ul class="playlist-select-options-list"></ul>
          </div>
          <div class="input-group">
            <input class="form-control" type="text" placeholder="New Playlist" />
            <div class="input-group-append">
              <button class="create-playlist-btn btn btn-sm btn-success" role="button">
                <i class="fa fa-plus"></i>
                Create
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary confirm-save">Add Video</button>
      </div>
    </div>
  </div>
</div>

<!-- Gource Command Modal -->
<div class="modal" id="display-gource-command-modal" tabindex="-1" role="dialog" aria-labelledby="display-gource-command-modal-title" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="display-gource-command-modal-title">Gource Command</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Use the following command to run this project's configuration:
        <button id="copy-gource-command-clipboard-btn" class="btn btn-xs btn-default" type="button" title="Copy command to clipboard"><i class="fa fa-clipboard"></i> Copy to Clipboard</button>
        <div id="display-gource-command-container"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
  <script src="/static/js/pages/project.js"></script>
  <script src="/static/js/lib/typeahead.bundle.js"></script>
  <script type="text/javascript">
    const PROJECT_ID = {{ project.id }};
    const CURRENT_USER = {{ current_user|safe }};
    const CAN_USER_EDIT = {{ user_can_edit|lower }};
    const IS_LATEST_BUILD = {{ is_latest_build|lower }};
    const PROJECT_USER_ROLE = "{{ project_user_role }}";
    const IS_READONLY = !CAN_USER_EDIT || !IS_LATEST_BUILD;
    $(document).ready(function() {
        "use strict";

        // Initialize page object
        App.pages.project.init(PROJECT_ID, {
            user: CURRENT_USER,
            user_role: PROJECT_USER_ROLE,
            can_user_edit: CAN_USER_EDIT,
            is_latest_build: IS_LATEST_BUILD,
            is_readonly: IS_READONLY,
        });

        $('[data-toggle="tooltip"]').tooltip();
        $('#project-manage-pane [data-toggle="popover"]').popover();

        // Load all available build options for Gource
        let gource_options = [{% for gource_opt in gource_options_json %}
            {{ gource_opt|safe }},{% endfor %}
        ];
        // Apply 'index' property to each item to retain order for later sorts
        _.each(gource_options, function(item, idx) {
            item.index = idx;
        }, this);

        // Load current build options
        let init_build_options = [{% for option_json in build_options_json %}
            {{ option_json|safe }},{% endfor %}
        ];
        App.pages.project.build_settings_container.loadAvailable(App.utils.cloneJSON(gource_options));
        let video_size_options = [{% for video_option in video_size_options %}{value: "{{ video_option.0 }}"},{% endfor %}];
        _.each(init_build_options, function(item) {
            App.debug && console.log("Initial build setting: ", item);
            App.pages.project.build_settings_container.addOption(item.name, item.value, item.value_type, true);
        });

        let init_build_captions = [{% for caption_json in build_captions_json %}
            {{ caption_json|safe }},{% endfor %}
        ];

        if (init_build_captions.length > 0) {
            _.each(init_build_captions, function(item) {
                let moment_timestamp = moment.utc(item.timestamp);
                item.timestamp = moment_timestamp.format('YYYY-MM-DD HH:mm:ss');
                App.pages.project.build_captions_container.captions_list.push(item);
            });
        }

        {% if user_can_edit %}
        // Load project options
        let init_project_options = [{% for option_json in project_options_json %}
            {{ option_json|safe }},{% endfor %}
        ];
        App.pages.project.project_audio_video_container.loadDefaults({
            build_audio: {% if project.build_audio %}"{% url 'api-project-build-audio-download' project.id %}"{% else %}null{% endif %},
            build_audio_name: {% if project.build_audio_name %}"{{ project.build_audio_name }}"{% else %}null{% endif %},
            build_audio_upload: "{% url 'project-audio-upload' project.id %}",
            build_logo: {% if project.build_logo %}"{% url 'api-project-logo-download' project.id %}"{% else %}null{% endif %},
            build_logo_upload: "{% url 'project-build-logo-upload' project.id %}",
            build_background: {% if project.build_background %}"{% url 'api-project-background-download' project.id %}"{% else %}null{% endif %},
            build_background_upload: "{% url 'project-build-background-upload' project.id %}",
            video_size: "{{ project.video_size }}",
            video_size_options: video_size_options,
            can_edit: !IS_READONLY,
        });
        App.pages.project.project_settings_container.loadAvailable(gource_options);

        _.each(init_project_options, function(item) {
            App.debug && console.log("Initial setting: ", item);
            App.pages.project.project_settings_container.addOption(item.name, item.value, item.value_type, true);
        });
        App.pages.project.refreshGourceDuration();

        let init_project_captions = [{% for caption_json in project_captions_json %}
            {{ caption_json|safe }},{% endfor %}
        ];

        if (init_project_captions.length > 0) {
            _.each(init_project_captions, function(item) {
                let moment_timestamp = moment.utc(item.timestamp);
                item.timestamp = moment_timestamp.format('YYYY-MM-DD HH:mm:ss');
                item.can_edit = !IS_READONLY;
                App.pages.project.project_captions_container.captions_list.push(item);
            });
        }

        let init_project_members_users = [{% for member_json in project_members_json %}
            {{ member_json|safe }},{% endfor %}
        ];
        if (init_project_members_users.length > 0) {
            _.each(init_project_members_users, function(item) {
                App.pages.project.project_members_container.addMember(item);
            });
        }

        const available_users = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.whitespace,
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            identify: function(obj) { return obj.id; },
            remote: {
                url: "/api/v1/users/?project_id="+PROJECT_ID+"&q=%QUERY",
                wildcard: '%QUERY'
            }
        });

        $('#new-member-input-container .typeahead').typeahead(null, {
            name: 'available-users',
            highlight: true,
            display: 'username',
            source: available_users,
            templates: {
                empty: [
                    '<div class="empty-message">',
                        '<i class="text-muted">No matches found</i>',
                    '</div>'
                ].join('\n'),
                suggestion: function(context) {
                    let account_name = _.filter([context.first_name, context.last_name]).join(" ");
                    return $(_.template('<div><% if (account_name) { %><%- account_name %> (<%- username %>)<% } else { %><%- username %><% } %></div>')({
                        account_name: account_name,
                        username: context.username,
                    }));
                },
            },
        });
        {% endif %}

        if (IS_READONLY) {
            // Remove selectable options
            // - Add Setting
            $('#project-gource-options-container').remove();
            // - Save Settings
            $('.save-project-settings-btn').remove();
            // - Add/Save Captions
            $('.add-caption-btn').remove();
            $('.project-caption-actions').remove()
        }
    });
  </script>
{% endblock %}
